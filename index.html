<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --main-blue: #248bcf; --bg-gray: #f4f7f9; --success: #28a745; --text-dark: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); padding: 15px; direction: rtl; margin: 0; color: var(--text-dark); }
        .header { text-align: center; padding: 10px 0; }
        .logo-circle { width: 90px; height: 90px; background: white url('logo.png') no-repeat center; background-size: contain; border-radius: 50%; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 3px solid var(--main-blue); }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .upload-area { border: 2px dashed var(--main-blue); padding: 25px; text-align: center; color: var(--main-blue); cursor: pointer; border-radius: 15px; transition: 0.3s; }
        .upload-area:active { background: #e1f0fa; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .opt-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.95rem; }
        .opt-btn.active { background: var(--main-blue) !important; color: white !important; border-color: var(--main-blue); }
        .opt-btn.inactive { background: white !important; color: var(--text-dark) !important; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px; background: #fafafa; }
        .invoice { background: #2c3e50; color: white; border-radius: 15px; padding: 20px; margin-top: 15px; }
        .inv-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .total-price { font-size: 1.4rem; color: #4eff4e; text-align: center; margin-top: 15px; border-top: 1px dashed #5d6d7e; padding-top: 15px; font-weight: bold; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .progress-container { width: 100%; background: #ddd; height: 8px; border-radius: 4px; margin: 15px 0; display: none; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); }
        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 400px; }
        .file-item { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-count { background: #eee; border: 1px solid #ddd; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .image-note { color: var(--main-blue); font-size: 0.85rem; font-weight: bold; margin: 12px 0; display: none; border: 1px solid #b3d7ff; padding: 10px; border-radius: 10px; background: #e7f3ff; text-align: center; }
        .ios-hint { font-size: 0.75rem; color: #777; margin-top: 8px; line-height: 1.4; }
    </style>
</head>
<body>

    <div id="welcome-modal">
        <div class="modal-content">
            <div class="logo-circle"></div>
            <h2 style="color:var(--main-blue)">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h2>
            <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø§Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯Ø§ØªÙƒ ÙˆØ³Ù†ØªÙˆÙ„Ù‰ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§ ÙˆØªÙˆØµÙŠÙ„Ù‡Ø§ Ø¥Ù„ÙŠÙƒ Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©.</p>
            <button class="btn-main" style="background: var(--main-blue); color:white;" onclick="closeWelcome()">Ø§Ø¨Ø¯Ø£ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="header">
            <div class="logo-circle"></div>
            <h1 style="margin:0; color:var(--main-blue);">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h1>
        </div>
        
        <div class="card">
            <div class="upload-area" onclick="document.getElementById('fileInp').click()">
                <span style="font-size: 1.2rem;">ğŸ“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª</span>
                <div class="ios-hint">ÙŠØ¯Ø¹Ù… PDF, Word, Excel, PowerPoint ÙˆØ§Ù„ØµÙˆØ±<br>(Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø¢ÙŠÙÙˆÙ†: Ø§Ø®ØªØ± "ØªØµÙØ­" Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)</div>
            </div>
            <input type="file" id="fileInp" multiple style="display:none">
        </div>

        <div id="list" class="card" style="display:none;"></div>
        
        <div id="opts" style="display:none;">
            <div class="card">
                <p><b>Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</b></p>
                <div class="btn-group">
                    <button id="c-btn" class="opt-btn active" onclick="setConf('color','c')">ğŸŒˆ Ù…Ù„ÙˆÙ†</button>
                    <button id="n-btn" class="opt-btn inactive" onclick="setConf('color','n')">âšª Ø£Ø³ÙˆØ¯</button>
                </div>
                
                <div id="img-alert" class="image-note">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØµÙˆØ± ØªÙØ·Ø¨Ø¹ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.</div>

                <div id="side-selection-container">
                    <p style="margin-top:20px;"><b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</b></p>
                    <div class="btn-group">
                        <button id="s1-btn" class="opt-btn active" onclick="setConf('side','1')">ğŸ“„ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯</button>
                        <button id="s2-btn" class="opt-btn inactive" onclick="setConf('side','2')">ğŸ“– ÙˆØ¬Ù‡ÙŠÙ†</button>
                    </div>
                </div>
            </div>

            <div class="invoice">
                <div id="inv-details"></div>
                <div class="total-price" id="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯.Ø¹</div>
            </div>

            <div class="card" style="margin-top:20px;">
                <input type="text" id="uName" placeholder="âœï¸ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="tel" id="uPhone" placeholder="ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªÙˆØ§ØµÙ„">
                <button id="locBtn" class="btn-main" style="background:#6c757d; color:white; font-size:0.9rem;" onclick="askLoc()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
                <div class="progress-container" id="p-cont"><div class="progress-bar" id="p-bar"></div></div>
                <button id="sendBtn" class="btn-main" style="background:var(--success); color:white; margin-top:15px;" onclick="sendOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready();
        let files = []; let conf = { color: 'c', side: '1' };
        let locUrl = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const botToken = '8446310296:AAGmDZreQq53tzxE8UPjN35AtzfvBQAR6xc';
        const myChatId = '7618746133';

        function closeWelcome() { document.getElementById('welcome-modal').style.display = 'none'; }

        document.getElementById('fileInp').onchange = async (e) => {
            const allowed = ['.pdf', '.docx', '.doc', '.xlsx', '.xls', '.pptx', '.ppt', '.jpg', '.jpeg', '.png', '.webp'];
            for (let f of e.target.files) {
                const name = f.name.toLowerCase();
                const ext = name.substring(name.lastIndexOf('.'));
                if (!allowed.includes(ext) && !f.type.startsWith('image/')) continue;

                let obj = { file: f, name: f.name, p: 1, c: 1, isImg: f.type.startsWith('image/'), type: 'Ù…Ù„Ù' };
                try {
                    const buffer = await f.arrayBuffer();
                    if (name.endsWith('.pdf')) {
                        const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
                        obj.p = pdf.numPages; obj.type = 'PDF'; obj.isImg = false;
                    } else if (name.endsWith('.docx') || name.endsWith('.doc')) {
                        const res = await mammoth.extractRawText({arrayBuffer: buffer});
                        const words = res.value.trim().split(/\s+/).length;
                        obj.p = Math.max(1, Math.ceil(words / 300));
                        obj.type = 'Word'; obj.isImg = false;
                    } else if (name.endsWith('.pptx') || name.endsWith('.ppt')) {
                        const zip = await JSZip.loadAsync(buffer);
                        const xml = await zip.file("docProps/app.xml").async("string");
                        const m = xml.match(/<Slides>(\d+)<\/Slides>/);
                        obj.p = m ? parseInt(m[1]) : 1; obj.type = 'PowerPoint'; obj.isImg = false;
                    } else if (obj.isImg) {
                        obj.type = 'ØµÙˆØ±Ø©';
                    }
                } catch (err) { obj.p = 1; }
                files.push(obj);
            }
            ui();
        };

        function setConf(k, v) {
            conf[k] = v;
            document.getElementById('c-btn').className = conf.color === 'c' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('n-btn').className = conf.color === 'n' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('s1-btn').className = conf.side === '1' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('s2-btn').className = conf.side === '2' ? 'opt-btn active' : 'opt-btn inactive';
            ui();
        }

        function askLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                locUrl = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('locBtn').innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
                document.getElementById('locBtn').style.background = "#28a745";
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ"));
        }

        function ui() {
            const list = document.getElementById('list'); list.innerHTML = '';
            let sheets = 0, imgs = 0, docsPages = 0;
            let hasDocs = false, hasImgs = false;

            files.forEach((f, i) => {
                if (!f.isImg) hasDocs = true; else hasImgs = true;
                list.innerHTML += `<div class="file-item">
                    <span style="font-size:0.85rem; font-weight:bold;">${f.name.substring(0,20)} (${f.p} Øµ)</span>
                    <div>
                        <button class="btn-count" onclick="cnt(${i},-1)">-</button>
                        <span style="padding:0 8px; font-weight:bold;">${f.c}</span>
                        <button class="btn-count" onclick="cnt(${i},1)">+</button>
                        <span onclick="del(${i})" style="color:red; margin-right:12px; cursor:pointer; font-size:0.8rem;">Ø­Ø°Ù</span>
                    </div>
                </div>`;
                let unit = f.p;
                if (f.type === 'PowerPoint') unit = Math.ceil(f.p / 2);
                if (f.isImg) imgs += f.c;
                else {
                    docsPages += (f.p * f.c);
                    sheets += (conf.side === '2' ? Math.ceil(unit / 2) : unit) * f.c;
                }
            });

            document.getElementById('side-selection-container').style.display = hasDocs ? 'block' : 'none';
            document.getElementById('img-alert').style.display = hasImgs ? 'block' : 'none';
            
            // Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
            let printPrice = 0;
            let totalUnits = sheets + imgs;

            if (conf.color === 'c') {
                if (totalUnits >= 1 && totalUnits <= 25) {
                    printPrice = totalUnits * 150;
                } else if (totalUnits >= 26 && totalUnits <= 40) {
                    printPrice = totalUnits * 120;
                } else if (totalUnits > 40 && totalUnits <= 70) {
                    printPrice = totalUnits * 110;
                } else if (totalUnits > 70) {
                    printPrice = totalUnits * 100;
                }
            } else {
                let pricePerSheetBlack = (conf.side === '1' ? 90 : 75);
                printPrice = totalUnits * pricePerSheetBlack;
            }

            let total = printPrice + (files.length > 0 ? 1000 : 0);
            
            document.getElementById('inv-details').innerHTML = `
                <div class="inv-line"><span>ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:</span><span>${docsPages}</span></div>
                <div class="inv-line"><span>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:</span><span>${imgs}</span></div>
                <div class="inv-line" style="border-top:1px solid #5d6d7e; padding-top:5px;"><span>Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span><span>${printPrice.toLocaleString()} Ø¯.Ø¹</span></div>
                <div class="inv-line"><span>Ø£Ø¬ÙˆØ± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©:</span><span>ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ </span></div>`;
            
            document.getElementById('total').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toLocaleString()} Ø¯.Ø¹`;
            document.getElementById('list').style.display = files.length ? 'block' : 'none';
            document.getElementById('opts').style.display = files.length ? 'block' : 'none';
            window.finalTotal = total;
        }

        window.cnt = (i, d) => { files[i].c = Math.max(1, files[i].c + d); ui(); };
        window.del = (i) => { files.splice(i, 1); ui(); };

        async function sendOrder() {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            if (!name || !phone || !files.length) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨... ğŸš€";
            document.getElementById('p-cont').style.display = 'block';
            
            try {
                const zip = new JSZip();
                let summary = "";
                files.forEach(f => {
                    zip.file(f.name, f.file);
                    summary += `\nğŸ“„ ${f.name} (${f.c} Ù†Ø³Ø®Ø©)`;
                });
                
                const blob = await zip.generateAsync({type:"blob"}, p => {
                    document.getElementById('p-bar').style.width = p.percent + "%";
                });
                
                const orderId = "WR-" + Math.floor(1000 + Math.random() * 9000);
                const fd = new FormData();
                fd.append('chat_id', myChatId); 
                fd.append('document', blob, `Order_${orderId}_${name}.zip`);
                fd.append('caption', `ğŸ†• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ #${orderId}\nğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${name}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${window.finalTotal.toLocaleString()} Ø¯.Ø¹\nğŸ¨ Ø§Ù„Ù†ÙˆØ¹: ${conf.color==='c'?'Ù…Ù„ÙˆÙ†':'Ø£Ø³ÙˆØ¯'}\nğŸ“– Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${conf.side==='1'?'ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯':'ÙˆØ¬Ù‡ÙŠÙ†'}\n\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„:${summary}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${locUrl}`);
                
                await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {method:'POST', body:fd});
                
                const userId = tg.initDataUnsafe?.user?.id;
                if(userId) {
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: userId, 
                            text: `âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… #${orderId} Ø¨Ù†Ø¬Ø§Ø­!\nğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${window.finalTotal.toLocaleString()} Ø¯.Ø¹\nğŸ“ Ø³ÙŠØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² ÙˆØ§Ù„ØªÙˆØµÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹.\nÙ„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 07752564099\nØ´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ âœ¨`
                        })
                    });
                }
                document.getElementById('main-ui').innerHTML = `<div style='text-align:center; padding:80px 20px;'><h2 style='color:var(--main-blue)'>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! âœ…</h2><p>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <b>#${orderId}</b></p><button onclick='tg.close()' class='btn-main' style='background:var(--main-blue); color:white; margin-top:20px;'>Ø¥ØºÙ„Ø§Ù‚</button></div>`;
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"); btn.disabled = false; }
        }
    </script>
</body>
</html>


