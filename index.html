<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .upload-box { border: 2px dashed #248bcf; padding: 20px; border-radius: 10px; cursor: pointer; margin-bottom: 20px; background: rgba(36, 139, 207, 0.05); }
        .file-item { background: rgba(0,0,0,0.05); margin: 10px 0; padding: 15px; border-radius: 8px; text-align: right; border: 1px solid rgba(0,0,0,0.1); }
        .file-row { display: flex; justify-content: space-between; align-items: center; }
        .copy-control { display: flex; align-items: center; gap: 5px; background: #fff; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .copy-control input { width: 40px; border: none; text-align: center; font-weight: bold; }
        
        .section-title { text-align: right; font-weight: bold; margin: 15px 0 10px; color: #248bcf; border-right: 4px solid #248bcf; padding-right: 10px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .opt-btn { background: #fff; border: 2px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px; position: relative; }
        .opt-btn.active { border-color: #248bcf; background: rgba(36, 139, 207, 0.1); }
        .opt-btn input { position: absolute; opacity: 0; }

        .invoice-card { background: rgba(0,0,0,0.04); padding: 15px; border-radius: 12px; display: none; margin-top: 20px; border: 1px solid #ddd; }
        .price-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        .grand-total { font-size: 1.3em; font-weight: bold; color: #248bcf; border-top: 2px solid #248bcf; margin-top: 10px; padding-top: 10px; }
        
        .user-info-section { margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .confirm-btn { background: #248bcf; color: white; }
        .loc-btn { background: #4caf50; color: white; font-size: 14px; }
        .delete-btn { background: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="main-app">
        <h1>ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚</h1>
        
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display:none">
            <p>â• Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDF Ø£Ùˆ ØµÙˆØ±</p>
        </div>

        <div id="fileList"></div>

        <div id="invoice" class="invoice-card">
            <div id="optionsSection">
                <div class="section-title">Ù†ÙˆØ¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</div>
                <div class="options-grid">
                    <label class="opt-btn active" id="lbl-color-c">ğŸŒˆ Ù…Ù„ÙˆÙ† <input type="radio" name="colorMode" value="c" checked onchange="updateOptionsUI()"></label>
                    <label class="opt-btn" id="lbl-color-n">âšª Ø¹Ø§Ø¯ÙŠ <input type="radio" name="colorMode" value="n" onchange="updateOptionsUI()"></label>
                </div>

                <div class="section-title">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</div>
                <div class="options-grid">
                    <label class="opt-btn active" id="lbl-side-1">ğŸ“„ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ <input type="radio" name="sideMode" value="1" checked onchange="updateOptionsUI()"></label>
                    <label class="opt-btn" id="lbl-side-2">ğŸ“– ÙˆØ¬Ù‡ÙŠÙ† <input type="radio" name="sideMode" value="2" onchange="updateOptionsUI()"></label>
                </div>
            </div>

            <div class="section-title">Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©:</div>
            <div id="priceDisplay"></div>

            <div class="user-info-section">
                <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:</div>
                <input type="text" id="userName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                <input type="tel" id="userPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                <button type="button" class="loc-btn" onclick="getLocation()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø±Ø·Ø©</button>
                <p id="locStatus" style="font-size: 0.8em; color: #4caf50; text-align: center;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯</p>
                <button id="confirmBtn" class="confirm-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ âœ…</button>
            </div>
        </div>
    </div>

    <div id="success-screen" style="display:none; padding: 50px 20px;">
        <div style="font-size: 60px;">âœ…</div>
        <h2>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!</h2>
        <p>Ø³Ù†ØªØµÙ„ Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯.</p>
        <button onclick="tg.close()" style="background: #4caf50; color: white;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        let allFiles = [];
        let userLocation = "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯";
        const botToken = '8234329147:AAF_jZ23898e_xJivB23HQe_gRnknFBuXnA';
        const myChatId = '7618746133';

        document.getElementById('fileInput').onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (let f of files) {
                if (!allFiles.some(ex => ex.name === f.name && ex.size === f.size)) {
                    let fileObj = { file: f, name: f.name, pages: '...', isImg: f.type.startsWith('image/'), copies: 1 };
                    allFiles.push(fileObj);
                    render();
                    if (f.type === 'application/pdf') {
                        const data = await f.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data}).promise;
                        fileObj.pages = pdf.numPages;
                    } else { fileObj.pages = 1; }
                    render();
                }
            }
        };

        function render() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            if (allFiles.length > 0) {
                document.getElementById('invoice').style.display = 'block';
                allFiles.forEach((f, i) => {
                    list.innerHTML += `
                        <div class="file-item">
                            <div class="file-row">
                                <div style="flex:2;"><strong>${f.name.substring(0,25)}</strong><br><small>${f.pages} ØµÙØ­Ø©</small></div>
                                <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                                    <div class="copy-control">
                                        <small>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®:</small>
                                        <input type="number" value="${f.copies}" min="1" onchange="updateCopies(${i}, this.value)">
                                    </div>
                                    <button class="delete-btn" onclick="removeFile(${i})">Ø­Ø°Ù</button>
                                </div>
                            </div>
                        </div>`;
                });
            } else { document.getElementById('invoice').style.display = 'none'; }
            calculate();
        }

        function updateOptionsUI() {
            const color = document.querySelector('input[name="colorMode"]:checked').value;
            const side = document.querySelector('input[name="sideMode"]:checked').value;
            
            document.querySelectorAll('.opt-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lbl-color-' + color).classList.add('active');
            document.getElementById('lbl-side-' + side).classList.add('active');
            calculate();
        }

        window.updateCopies = (i, v) => { allFiles[i].copies = parseInt(v) || 1; calculate(); };
        window.removeFile = (i) => { allFiles.splice(i, 1); render(); };

        function calculate() {
            const colorMode = document.querySelector('input[name="colorMode"]:checked').value;
            const sideMode = document.querySelector('input[name="sideMode"]:checked').value;
            let pdfPaperCount = 0;
            let imagesCount = 0;
            
            allFiles.forEach(f => {
                if (f.isImg) imagesCount += f.copies;
                else if (typeof f.pages === 'number') {
                    let p = (sideMode === '2') ? Math.ceil(f.pages / 2) : f.pages;
                    pdfPaperCount += (p * f.copies);
                }
            });

            let totalUnits = pdfPaperCount + imagesCount;
            let printPrice = 0;

            if (totalUnits > 0) {
                if (colorMode === 'c') {
                    if (totalUnits < 10) printPrice = 1000;
                    else if (totalUnits <= 39) printPrice = totalUnits * 150;
                    else if (totalUnits <= 59) printPrice = totalUnits * 120;
                    else printPrice = totalUnits * 100;
                } else {
                    printPrice = totalUnits * (sideMode === '1' ? 90 : 75);
                    if (printPrice < 500) printPrice = 500;
                }
            }

            window.finalTotal = printPrice + 1000;
            let html = '';
            if (pdfPaperCount > 0) html += `<div class="price-row"><span>Ø¹Ø¯Ø¯ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ù„ÙØ§Øª:</span><span>${pdfPaperCount} ÙˆØ±Ù‚Ø©</span></div>`;
            if (imagesCount > 0) html += `<div class="price-row"><span>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±:</span><span>${imagesCount} ØµÙˆØ±Ø©</span></div>`;
            html += `<div class="price-row"><span>Ø£Ø¬ÙˆØ± Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span>1,000 Ø¯.Ø¹</span></div>`;
            html += `<div class="price-row grand-total"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span><span>${window.finalTotal.toLocaleString()} Ø¯.Ø¹</span></div>`;
            document.getElementById('priceDisplay').innerHTML = html;
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                userLocation = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('locStatus').innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­";
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"));
        }

        async function uploadFile(fObj, name) {
            const formData = new FormData();
            formData.append('chat_id', myChatId);
            formData.append('document', fObj.file);
            const color = document.querySelector('input[name="colorMode"]:checked').parentElement.innerText;
            const side = document.querySelector('input[name="sideMode"]:checked').parentElement.innerText;
            formData.append('caption', `Ø§Ù„Ø²Ø¨ÙˆÙ†: ${name}\nÙ†Ø³Ø®: ${fObj.copies}\nÙ†ÙˆØ¹: ${color} - ${side}`);
            return fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, { method: 'POST', body: formData });
        }

        document.getElementById('confirmBtn').onclick = async () => {
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            if (!name || !phone) { alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ù‡Ø§ØªÙÙƒ!"); return; }
            document.getElementById('confirmBtn').disabled = true;
            document.getElementById('confirmBtn').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„... ğŸš€";

            try {
                const summary = `ğŸ“¦ **Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯**\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${window.finalTotal}\nğŸ“ [Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„](${userLocation})`;
                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({chat_id: myChatId, text: summary, parse_mode: 'Markdown'})
                });

                for (let f of allFiles) await uploadFile(f, name);

                const userTgId = tg.initDataUnsafe?.user?.id;
                if (userTgId) {
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({chat_id: userTgId, text: `âœ… Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ø·Ù„Ø¨Ùƒ ÙŠØ§ ${name}\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${window.finalTotal} Ø¯.Ø¹\nØ³Ù†ØªØµÙ„ Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.`})
                    });
                }
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('success-screen').style.display = 'block';
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); }
        };
    </script>
</body>
</html>
