<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --main-blue: #248bcf; --bg-gray: #f2f2f2; --success: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); padding: 15px; direction: rtl; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed var(--main-blue); padding: 20px; text-align: center; color: var(--main-blue); font-weight: bold; cursor: pointer; border-radius: 12px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .btn-count { background: var(--main-blue); color: white; border: none; width: 25px; height: 25px; border-radius: 5px; }
        .invoice { background: #333; color: white; border-radius: 12px; padding: 15px; }
        .inv-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .total-price { font-size: 1.4rem; color: #4eff4e; text-align: center; margin-top: 10px; border-top: 1px dashed #666; padding-top: 10px; }
        .progress-container { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); border-radius: 5px; transition: width 0.3s; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="main-ui">
        <h2 style="text-align:center;">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ ğŸ“š</h2>
        <div class="card upload-area" onclick="document.getElementById('fileInp').click()">
            <input type="file" id="fileInp" multiple accept=".pdf,image/*,.docx,.pptx" style="display:none">
            Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± ğŸ“
        </div>

        <div id="list" class="card" style="display:none;"></div>

        <div id="opts" style="display:none;">
            <div class="card">
                <p><b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</b></p>
                <div style="display:flex; gap:10px;">
                    <button id="c-btn" class="btn-main" style="background:var(--main-blue); color:white;" onclick="setConf('color','c')">ğŸŒˆ Ù…Ù„ÙˆÙ†</button>
                    <button id="n-btn" class="btn-main" style="background:white; border:1px solid #ccc;" onclick="setConf('color','n')">âšª Ø£Ø³ÙˆØ¯</button>
                </div>
                <div id="side-div" style="display:flex; gap:10px; margin-top:10px;">
                    <button id="s1-btn" class="btn-main" style="background:var(--main-blue); color:white;" onclick="setConf('side','1')">ğŸ“„ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯</button>
                    <button id="s2-btn" class="btn-main" style="background:white; border:1px solid #ccc;" onclick="setConf('side','2')">ğŸ“– ÙˆØ¬Ù‡ÙŠÙ†</button>
                </div>
            </div>

            <div class="invoice">
                <div id="inv-details"></div>
                <div class="total-price" id="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯.Ø¹</div>
            </div>

            <div class="card">
                <input type="text" id="uName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="tel" id="uPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                <button id="locBtn" class="btn-main" style="background:#6c757d; color:white;" onclick="askLoc()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)</button>
                <div class="progress-container" id="p-cont"><div class="progress-bar" id="p-bar"></div></div>
                <button id="sendBtn" class="btn-main" style="background:var(--success); color:white;" onclick="sendOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready();
        let files = []; let conf = { color: 'c', side: '1' };
        let locUrl = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const bot = '8446310296:AAGd7EjTJJYYzeTDIPQlSnjPypS5k3QYi3o';
        const chat = '7618746133';

        document.getElementById('fileInp').onchange = async (e) => {
            for (let f of e.target.files) {
                let obj = { file: f, name: f.name, p: 1, c: 1, isImg: f.type.startsWith('image/'), type: 'ØµÙˆØ±Ø©' };
                if (f.type.includes('pdf')) {
                    const pdf = await pdfjsLib.getDocument({data: await f.arrayBuffer()}).promise;
                    obj.p = pdf.numPages; obj.type = 'PDF';
                } else if (f.name.endsWith('.pptx')) {
                    const zip = await JSZip.loadAsync(await f.arrayBuffer());
                    const xml = await zip.file("docProps/app.xml").async("string");
                    const m = xml.match(/<Slides>(\d+)<\/Slides>/);
                    obj.p = m ? parseInt(m[1]) : 1; obj.type = 'PowerPoint';
                }
                files.push(obj);
            }
            ui();
        };

        function setConf(k, v) {
            conf[k] = v;
            document.getElementById('c-btn').style.background = conf.color === 'c' ? '#248bcf' : 'white';
            document.getElementById('n-btn').style.background = conf.color === 'n' ? '#248bcf' : 'white';
            document.getElementById('s1-btn').style.background = conf.side === '1' ? '#248bcf' : 'white';
            document.getElementById('s2-btn').style.background = conf.side === '2' ? '#248bcf' : 'white';
            ui();
        }

        function askLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                locUrl = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('locBtn').innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­";
                document.getElementById('locBtn').style.background = "#28a745";
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS"));
        }

        function ui() {
            const list = document.getElementById('list'); list.innerHTML = '';
            let sheets = 0, imgs = 0, docsPages = 0;
            
            files.forEach((f, i) => {
                list.innerHTML += `<div class="file-item">
                    <span>${f.name.substring(0,15)} (${f.p} Øµ)</span>
                    <div>
                        <button class="btn-count" onclick="cnt(${i},-1)">-</button>
                        <span style="padding:0 5px">${f.c}</span>
                        <button class="btn-count" onclick="cnt(${i},1)">+</button>
                        <span onclick="del(${i})" style="color:red; margin-right:10px; cursor:pointer">Ø­Ø°Ù</span>
                    </div>
                </div>`;
                
                let unit = f.p;
                if (f.type === 'PowerPoint') unit = Math.ceil(f.p / 2); // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨Ø§ÙˆØ±Ø¨ÙˆÙŠÙ†Øª
                
                if (f.isImg) imgs += f.c;
                else {
                    docsPages += (f.p * f.c);
                    sheets += (conf.side === '2' ? Math.ceil(unit / 2) : unit) * f.c;
                }
            });

            let printPrice = (sheets + imgs) * (conf.color === 'c' ? 150 : (conf.side === '1' ? 90 : 75));
            let total = printPrice + (files.length > 0 ? 1000 : 0);
            
            document.getElementById('inv-details').innerHTML = `
                <div class="inv-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:</span><span>${docsPages}</span></div>
                <div class="inv-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±:</span><span>${imgs}</span></div>
                <div class="inv-line"><span>ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø©:</span><span>${sheets + imgs}</span></div>
                <div class="inv-line"><span>Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span><span>${printPrice.toLocaleString()} Ø¯.Ø¹</span></div>
                <div class="inv-line"><span>Ø£Ø¬ÙˆØ± Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span>1,000 Ø¯.Ø¹</span></div>`;
            
            document.getElementById('total').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toLocaleString()} Ø¯.Ø¹`;
            document.getElementById('list').style.display = files.length ? 'block' : 'none';
            document.getElementById('opts').style.display = files.length ? 'block' : 'none';
            window.finalTotal = total;
        }

        window.cnt = (i, d) => { files[i].c = Math.max(1, files[i].c + d); ui(); };
        window.del = (i) => { files.splice(i, 1); ui(); };

        async function sendOrder() {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            if (!name || !phone || !files.length) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... ğŸš€";
            document.getElementById('p-cont').style.display = 'block';

            const zip = new JSZip();
            files.forEach(f => zip.file(f.name, f.file));
            const blob = await zip.generateAsync({type:"blob"}, p => {
                document.getElementById('p-bar').style.width = p.percent + "%";
            });

            const fd = new FormData();
            fd.append('chat_id', chat); fd.append('document', blob, `Order_${name}.zip`);
            fd.append('caption', `ğŸ“¦ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\nğŸ‘¤ ${name}\nğŸ“ ${phone}\nğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${window.finalTotal.toLocaleString()}\nğŸ¨ ${conf.color==='c'?'Ù…Ù„ÙˆÙ†':'Ø£Ø³ÙˆØ¯'}\nğŸ“– ${conf.side==='1'?'ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯':'ÙˆØ¬Ù‡ÙŠÙ†'}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${locUrl}`);

            await fetch(`https://api.telegram.org/bot${bot}/sendDocument`, {method:'POST', body:fd});
            document.getElementById('main-ui').innerHTML = "<h2 style='text-align:center; padding:50px;'>âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h2>";
        }
    </script>
</body>
</html>
