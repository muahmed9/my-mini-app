<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --main-blue: #248bcf; --bg-gray: #f4f7f9; --success: #28a745; --text-dark: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); padding: 15px; direction: rtl; margin: 0; color: var(--text-dark); }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù„ÙˆØºÙˆ */
        .header { text-align: center; padding: 10px 0; }
        .logo-circle { width: 80px; height: 80px; background: var(--main-blue); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        .upload-area { border: 2px dashed var(--main-blue); padding: 30px; text-align: center; color: var(--main-blue); font-weight: bold; cursor: pointer; border-radius: 15px; transition: 0.3s; }
        .upload-area:active { background: #eef7ff; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .opt-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.95rem; }
        .opt-btn.active { background: var(--main-blue) !important; color: white !important; border-color: var(--main-blue); }
        .opt-btn.inactive { background: white !important; color: var(--text-dark) !important; }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-group { margin-bottom: 15px; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 1rem; outline: none; transition: 0.3s; background: #fafafa; }
        input:focus { border-color: var(--main-blue); background: white; box-shadow: 0 0 0 3px rgba(36,139,207,0.1); }

        .invoice { background: #2c3e50; color: white; border-radius: 15px; padding: 20px; }
        .inv-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; opacity: 0.9; }
        .total-price { font-size: 1.5rem; color: #4eff4e; text-align: center; margin-top: 15px; border-top: 1px dashed #5d6d7e; padding-top: 15px; font-weight: bold; }

        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .progress-container { width: 100%; background: #ddd; height: 8px; border-radius: 4px; margin: 15px 0; display: none; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 400px; }
    </style>
</head>
<body>

    <div id="welcome-modal">
        <div class="modal-content">
            <div class="logo-circle">ğŸ“š</div>
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ÙˆØ±Ø§Ù‚</h2>
            <p>ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø®Ø¯Ù…ØªÙƒ! Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒØŒ Ø­Ø¯Ø¯ Ø®ÙŠØ§Ø±Ø§ØªÙƒØŒ ÙˆØ³Ù†ØµÙ„ Ø¥Ù„ÙŠÙƒ Ø£ÙŠÙ†Ù…Ø§ ÙƒÙ†Øª.</p>
            <button class="btn-main" style="background: var(--main-blue); color:white;" onclick="closeWelcome()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="header">
            <div class="logo-circle">ğŸ“š</div>
            <h1 style="margin:0; color:var(--main-blue);">Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚</h1>
            <p style="margin:5px 0; opacity:0.7;">Ø£Ø³Ø±Ø¹ Ø®Ø¯Ù…Ø© Ø·Ø¨Ø§Ø¹Ø© ÙˆØªÙˆØµÙŠÙ„</p>
        </div>

        <div class="card upload-area" onclick="document.getElementById('fileInp').click()">
            <input type="file" id="fileInp" multiple accept=".pdf,image/*,.docx,.pptx" style="display:none">
            <span style="font-size: 1.2rem;">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± ğŸ“</span>
        </div>

        <div id="list" class="card" style="display:none;"></div>

        <div id="opts" style="display:none;">
            <div class="card">
                <p style="margin-top:0;"><b>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</b></p>
                <div class="btn-group">
                    <button id="c-btn" class="opt-btn active" onclick="setConf('color','c')">ğŸŒˆ Ù…Ù„ÙˆÙ†</button>
                    <button id="n-btn" class="opt-btn inactive" onclick="setConf('color','n')">âšª Ø£Ø³ÙˆØ¯</button>
                </div>
                <div id="side-div">
                    <p style="margin-top:20px; margin-bottom:10px;"><b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</b></p>
                    <div class="btn-group">
                        <button id="s1-btn" class="opt-btn active" onclick="setConf('side','1')">ğŸ“„ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯</button>
                        <button id="s2-btn" class="opt-btn inactive" onclick="setConf('side','2')">ğŸ“– ÙˆØ¬Ù‡ÙŠÙ†</button>
                    </div>
                </div>
            </div>

            <div class="invoice">
                <div id="inv-details"></div>
                <div class="total-price" id="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯.Ø¹</div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="input-group">
                    <input type="text" id="uName" placeholder="âœï¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²Ø¨ÙˆÙ†">
                </div>
                <div class="input-group">
                    <input type="tel" id="uPhone" placeholder="ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªÙˆØ§ØµÙ„">
                </div>
                <button id="locBtn" class="btn-main" style="background:#6c757d; color:white; font-size:0.9rem;" onclick="askLoc()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (GPS)</button>
                <div class="progress-container" id="p-cont"><div class="progress-bar" id="p-bar"></div></div>
                <button id="sendBtn" class="btn-main" style="background:var(--success); color:white; margin-top:15px;" onclick="sendOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† âœ…</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready();
        let files = []; let conf = { color: 'c', side: '1' };
        let locUrl = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const bot = '8446310296:AAGd7EjTJJYYzeTDIPQlSnjPypS5k3QYi3o';
        const chat = '7618746133';

        function closeWelcome() { document.getElementById('welcome-modal').style.display = 'none'; }

        document.getElementById('fileInp').onchange = async (e) => {
            for (let f of e.target.files) {
                let obj = { file: f, name: f.name, p: 1, c: 1, isImg: f.type.startsWith('image/'), type: 'ØµÙˆØ±Ø©' };
                if (f.type.includes('pdf')) {
                    const pdf = await pdfjsLib.getDocument({data: await f.arrayBuffer()}).promise;
                    obj.p = pdf.numPages; obj.type = 'PDF';
                } else if (f.name.endsWith('.pptx')) {
                    const zip = await JSZip.loadAsync(await f.arrayBuffer());
                    const xml = await zip.file("docProps/app.xml").async("string");
                    const m = xml.match(/<Slides>(\d+)<\/Slides>/);
                    obj.p = m ? parseInt(m[1]) : 1; obj.type = 'PowerPoint';
                }
                files.push(obj);
            }
            ui();
        };

        function setConf(k, v) {
            conf[k] = v;
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('c-btn').className = conf.color === 'c' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('n-btn').className = conf.color === 'n' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('s1-btn').className = conf.side === '1' ? 'opt-btn active' : 'opt-btn inactive';
            document.getElementById('s2-btn').className = conf.side === '2' ? 'opt-btn active' : 'opt-btn inactive';
            ui();
        }

        function askLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                locUrl = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('locBtn').innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
                document.getElementById('locBtn').style.background = "#28a745";
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ"));
        }

        function ui() {
            const list = document.getElementById('list'); list.innerHTML = '';
            let sheets = 0, imgs = 0, docsPages = 0;
            
            files.forEach((f, i) => {
                list.innerHTML += `<div class="file-item" style="padding:10px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;">${f.name.substring(0,18)} (${f.p} Øµ)</span>
                    <div>
                        <button class="btn-count" style="background:#eee; color:#333; border:1px solid #ddd; width:30px; height:30px; border-radius:8px;" onclick="cnt(${i},-1)">-</button>
                        <span style="padding:0 8px; font-weight:bold;">${f.c}</span>
                        <button class="btn-count" style="background:#eee; color:#333; border:1px solid #ddd; width:30px; height:30px; border-radius:8px;" onclick="cnt(${i},1)">+</button>
                        <span onclick="del(${i})" style="color:#e74c3c; margin-right:15px; cursor:pointer; font-size:0.85rem; font-weight:bold;">Ø­Ø°Ù</span>
                    </div>
                </div>`;
                
                let unit = f.p;
                if (f.type === 'PowerPoint') unit = Math.ceil(f.p / 2);
                
                if (f.isImg) imgs += f.c;
                else {
                    docsPages += (f.p * f.c);
                    sheets += (conf.side === '2' ? Math.ceil(unit / 2) : unit) * f.c;
                }
            });

            let printPrice = (sheets + imgs) * (conf.color === 'c' ? 150 : (conf.side === '1' ? 90 : 75));
            let total = printPrice + (files.length > 0 ? 1000 : 0);
            
            document.getElementById('inv-details').innerHTML = `
                <div class="inv-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:</span><span>${docsPages}</span></div>
                <div class="inv-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±:</span><span>${imgs}</span></div>
                <div class="inv-line"><span>Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ÙŠ:</span><span>${printPrice.toLocaleString()} Ø¯.Ø¹</span></div>
                <div class="inv-row" style="margin-top:5px; border-top:1px solid #5d6d7e; padding-top:5px; font-size:0.85rem;"><span>Ø£Ø¬ÙˆØ± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©:</span><span>1,000 Ø¯.Ø¹</span></div>`;
            
            document.getElementById('total').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${total.toLocaleString()} Ø¯.Ø¹`;
            document.getElementById('list').style.display = files.length ? 'block' : 'none';
            document.getElementById('opts').style.display = files.length ? 'block' : 'none';
            window.finalTotal = total;
        }

        window.cnt = (i, d) => { files[i].c = Math.max(1, files[i].c + d); ui(); };
        window.del = (i) => { files.splice(i, 1); ui(); };

        async function sendOrder() {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            if (!name || !phone || !files.length) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª... ğŸš€";
            document.getElementById('p-cont').style.display = 'block';

            const zip = new JSZip();
            files.forEach(f => zip.file(f.name, f.file));
            const blob = await zip.generateAsync({type:"blob"}, p => {
                document.getElementById('p-bar').style.width = p.percent + "%";
            });

            const fd = new FormData();
            fd.append('chat_id', chat); fd.append('document', blob, `Order_${name}.zip`);
            fd.append('caption', `ğŸ†• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙˆØ±Ø§Ù‚\nğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${name}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${window.finalTotal.toLocaleString()} Ø¯.Ø¹\nğŸ¨ Ø§Ù„Ù†ÙˆØ¹: ${conf.color==='c'?'Ù…Ù„ÙˆÙ†':'Ø£Ø³ÙˆØ¯'}\nğŸ“– Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${conf.side==='1'?'ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯':'ÙˆØ¬Ù‡ÙŠÙ†'}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${locUrl}`);

            await fetch(`https://api.telegram.org/bot${bot}/sendDocument`, {method:'POST', body:fd});
            document.getElementById('main-ui').innerHTML = "<div style='text-align:center; padding:100px 20px;'><div style='font-size:60px;'>âœ…</div><h2>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!</h2><p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p></div>";
        }
    </script>
</body>
</html>
