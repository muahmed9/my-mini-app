<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚ - Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØºØ±</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
        }
        .app-container { max-width: 500px; margin: auto; }
        .upload-section { 
            border: 2px dashed var(--tg-theme-button-color, #248bcf); 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            cursor: pointer;
        }
        select, button { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #ccc;
            font-size: 16px;
        }
        button { 
            background-color: var(--tg-theme-button-color, #248bcf); 
            color: var(--tg-theme-button-text-color, #ffffff); 
            border: none; 
            font-weight: bold;
        }
        .invoice { 
            background-color: rgba(0,0,0,0.05); 
            padding: 15px; 
            border-radius: 10px; 
            text-align: right; 
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ±Ø§Ù‚</h1>
        
        <div class="upload-section" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display:none">
            <p>ğŸ“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDF Ø£Ùˆ ØµÙˆØ±</p>
            <p id="fileCount" style="font-size: 0.8em; color: gray;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯</p>
        </div>

        <div id="results" style="display:none;">
            <div class="invoice">
                <h3>ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h3>
                <p id="stats">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª: 0 | Ø§Ù„ØµÙˆØ±: 0</p>
                
                <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</label>
                <select id="printType">
                    <option value="c_1">ğŸŒˆ Ù…Ù„ÙˆÙ† - ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ (150 Ø¯.Ø¹)</option>
                    <option value="c_2">ğŸŒˆ Ù…Ù„ÙˆÙ† - ÙˆØ¬Ù‡ÙŠÙ†</option>
                    <option value="n_1">âšª Ø¹Ø§Ø¯ÙŠ - ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ (90 Ø¯.Ø¹)</option>
                    <option value="n_2">âšª Ø¹Ø§Ø¯ÙŠ - ÙˆØ¬Ù‡ÙŠÙ† (75 Ø¯.Ø¹)</option>
                </select>
                
                <hr>
                <p>ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„: 1,000 Ø¯.Ø¹</p>
                <h2 id="totalPrice">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯.Ø¹</h2>
            </div>
            
            <button id="sendOrder">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸ›’</button>
        </div>
    </div>

    <script>
        // Ø¥Ø®Ø¨Ø§Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // ØªÙˆØ³ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø©

        const fileInput = document.getElementById('fileInput');
        const printType = document.getElementById('printType');
        let totalPages = 0;
        let totalPhotos = 0;

        // ÙˆØ¸ÙŠÙØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        function calculateFinalPrice() {
            const type = printType.value;
            let rawPrintPrice = 0;

            if (type.startsWith('c')) {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„ÙˆÙ†
                let units = totalPhotos + (type === 'c_1' ? totalPages : Math.ceil(totalPages / 2));
                rawPrintPrice = (units > 0 && units < 5) ? 1000 : units * 150;
            } else {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                let filePrice = type === 'n_1' ? totalPages * 90 : totalPages * 75;
                rawPrintPrice = filePrice + (totalPhotos * 90);
            }

            // Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 250 ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„
            let grandTotal = Math.ceil((rawPrintPrice + 1000) / 250) * 250;
            document.getElementById('totalPrice').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${grandTotal.toLocaleString()} Ø¯.Ø¹`;
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            totalPages = 0;
            totalPhotos = 0;

            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    totalPhotos++;
                } else if (file.type === 'application/pdf') {
                    // ÙƒÙˆØ¯ Ø¨Ø³ÙŠØ· Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø¯ ØµÙØ­Ø§Øª PDF
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        totalPages += pdf.numPages;
                        updateUI();
                    };
                    reader.readAsArrayBuffer(file);
                }
            }
            updateUI();
        });

        function updateUI() {
            document.getElementById('results').style.display = 'block';
            document.getElementById('stats').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª: ${totalPages} | Ø§Ù„ØµÙˆØ±: ${totalPhotos}`;
            document.getElementById('fileCount').innerText = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${fileInput.files.length} Ù…Ù„Ù/ØµÙˆØ±Ø©`;
            calculateFinalPrice();
        }

        printType.addEventListener('change', calculateFinalPrice);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        document.getElementById('sendOrder').addEventListener('click', () => {
            const data = {
                pages: totalPages,
                photos: totalPhotos,
                type: printType.options[printType.selectedIndex].text,
                total: document.getElementById('totalPrice').innerText
            };
            tg.sendData(JSON.stringify(data)); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            tg.close(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        });
    </script>
</body>
</html>
